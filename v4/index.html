<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>4 Chronos</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#ffffff">

  <!-- IcÃ´ne -->
  <link rel="icon" href="./icon_4_chrono_2.png">

  <!-- Styles -->
  <link rel="stylesheet" href="./style.css">

  <!-- Version -->
  <script src="./version.js"></script>
</head>

<body>

  <!-- HEADER -->
<header class="topbar">
  <div class="top-left">
    <img src="./icon_4_chrono_2.png" class="top-logo" alt="logo">
    <button id="btnHelp" class="btn-help">Aide</button>
  </div>

  <div class="top-title">
    Pot Ã  MÃ¨che
  </div>

  <div class="top-right">
    <div>B.Barrois</div>
    <div id="version">version</div>
  </div>
</header>


  <!-- ACTIONS HAUT DE PAGE -->
  <div class="top-actions">
    <button id="btnCapt" class="btn-capt">Capture dâ€™Ã©cran</button>

    <div id="dateTime" class="date-time"></div>

    <button id="btnLoc" class="btn-loc">Localisation du nid</button>
  </div>

  <!-- CONTENEUR DES CHRONOS -->
  <main id="chronos">
    <!-- GÃ©nÃ©rÃ© par app.js -->
  </main>

  <!-- SCRIPT PRINCIPAL -->
  <script src="./app.js"></script>

  <!-- AFFICHAGE VERSION -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const v = document.getElementById("version");
      if (v && typeof APP_VERSION !== "undefined") {
        v.textContent = "v. : " + APP_VERSION;
      }
    });
  </script>

  <!-- DATE & HEURE -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const el = document.getElementById("dateTime");
      if (!el) return;

      function updateDateTime() {
        const now = new Date();
        const d = now.toLocaleDateString("fr-FR");
        const t = now.toLocaleTimeString("fr-FR", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit"
        });
        el.textContent = `${d} ${t}`;
      }

      updateDateTime();
      setInterval(updateDateTime, 1000);
    });
  </script>

  <!-- SERVICE WORKER -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./service-worker.js");
    }
  </script>

  <!-- LIB CAPTURE Dâ€™Ã‰CRAN -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- BOUTON CAPTURE -->
  <script>
    document.getElementById("btnCapt").addEventListener("click", async () => {
      const canvas = await html2canvas(document.body, {
        scale: 2,
        useCORS: true
      });

      const blob = await new Promise(resolve =>
        canvas.toBlob(resolve, "image/png")
      );

      const filename =
        "Chrono_Frelon_" +
        new Date().toISOString().replace(/[:.]/g, "-") +
        ".png";

      if (navigator.share) {
        try {
          const file = new File([blob], filename, { type: "image/png" });
          await navigator.share({
            files: [file],
            title: "Chrono Frelon",
            text: "Capture dâ€™Ã©cran"
          });
          return;
        } catch (e) {}
      }

      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    });
  </script>

  <!-- BOUTON LOCALISATION -->
  <script>
    document.getElementById("btnLoc").addEventListener("click", () => {
      const observations = [];

      chronos.forEach(c => {
        if (c.lat === "--" || c.lon === "--") return;
        if (c.essais.length === 0) return;

        const total = c.essais.reduce((a, b) => a + b, 0);
        const moyenne = total / c.essais.length;
        const distance = Math.round((moyenne * c.vitesse) / 2);

        observations.push({
          color: c.color,
          lat: parseFloat(c.lat),
          lon: parseFloat(c.lon),
          direction: c.direction,
          distance: distance,
          vitesse: c.vitesse,
          essais: c.essais.length,
          timestamp: new Date().toISOString()
        });
      });

      if (observations.length === 0) {
        alert("Aucune donnÃ©e exploitable pour la localisation.");
        return;
      }

      localStorage.setItem(
        "chronoObservations",
        JSON.stringify(observations)
      );

      window.location.href = "./map.html";
    });
  </script>
<script>
document.getElementById("btnHelp").addEventListener("click", () => {
  const overlay = document.createElement("div");
  overlay.id = "helpOverlay";

  overlay.innerHTML = `
    <div class="help-box">
      <h2>Aide â€“ Application Â« Pot Ã  MÃ¨che Â»</h2>

      <h3>1ï¸âƒ£ Installation de lâ€™application</h3>

      <h4>ğŸ“± Android</h4>
      <ol>
        <li>Ouvrez <b>Google Chrome</b></li>
        <li>Allez sur :
          <br><b>https://berny70.github.io/Chrono_Frelon/</b>
        </li>
        <li>Appuyez sur le menu <b>â‹®</b></li>
        <li>SÃ©lectionnez <b>Â« Installer lâ€™application Â»</b></li>
      </ol>

      <h4>ğŸ iPhone (iOS)</h4>
      <ol>
        <li>Ouvrez <b>Safari</b> (obligatoire)</li>
        <li>Allez sur :
          <br><b>https://berny70.github.io/Chrono_Frelon/</b>
        </li>
        <li>Appuyez sur <b>Partager</b> (â¬†ï¸)</li>
        <li>Choisissez <b>Â« Sur lâ€™Ã©cran dâ€™accueil Â»</b></li>
      </ol>

      <hr>

      <h3>2ï¸âƒ£ Utilisation des chronos</h3>

      <p>
        Lâ€™application comporte <b>4 chronos indÃ©pendants</b>,
        chacun correspondant Ã  une <b>station dâ€™observation</b>.
      </p>

      <h4>ğŸŸ¢ Mise en place dâ€™une station</h4>
      <ul>
        <li>Placez le pot Ã  mÃ¨che</li>
        <li>Appuyez sur <b>Â« Position Â»</b> pour enregistrer la localisation</li>
      </ul>

      <h4>â±ï¸ Mesure du temps</h4>
      <ul>
        <li>Marquez un frelon (stylo Ã  reine)</li>
        <li>Appuyez sur <b>Start / Stop</b> Ã  son dÃ©part</li>
        <li>Appuyez Ã  nouveau Ã  son retour</li>
        <li>RÃ©pÃ©tez plusieurs fois</li>
      </ul>

      <h4>ğŸ§­ Mesure de la direction</h4>
      <ul>
        <li>Appuyez sur <b>Â« Boussole Â»</b></li>
        <li>Pointez le tÃ©lÃ©phone dans la direction du frelon</li>
        <li>Validez avec <b>Â« Capturer direction Â»</b></li>
        <li>La direction affichÃ©e est une <b>moyenne cyclique</b></li>
      </ul>

      <h4>ğŸ” VÃ©rification</h4>
      <ul>
        <li><b>DÃ©tail</b> : liste des temps et directions</li>
        <li>Suppression possible des valeurs aberrantes</li>
        <li><b>Reset</b> : remise Ã  zÃ©ro dâ€™une station</li>
      </ul>

      <h4>ğŸ—ºï¸ Localisation du nid</h4>
      <ul>
        <li>Bouton <b>Â« Localisation du nid Â»</b> en haut Ã  droite</li>
        <li>Affiche les stations et les vecteurs direction / distance</li>
      </ul>

      <h4>ğŸ“¸ Sauvegarde</h4>
      <ul>
        <li><b>Capture dâ€™Ã©cran</b> : image avec date et heure</li>
      </ul>

      <p style="margin-top:10px;">
        âœ”ï¸ Application gratuite<br>
        âœ”ï¸ Sans publicitÃ© â€“ sans compte<br>
        âœ”ï¸ Fonctionne hors connexion
      </p>

      <button onclick="closeHelp()">Fermer</button>
    </div>
  `;

  document.body.appendChild(overlay);
});

function closeHelp() {
  document.getElementById("helpOverlay")?.remove();
}
</script>

</body>
</html>
