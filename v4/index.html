<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>4 Chronos pour Pot √† M√®che</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#ffffff">

  <!-- Ic√¥ne -->
  <link rel="icon" href="./icon_4_chrono_2.png">

  <!-- Styles -->
  <link rel="stylesheet" href="./style.css">

  <!-- Version -->
  <script src="./version.js"></script>
</head>

<body>

  <!-- HEADER -->
<header class="topbar">
  <div class="top-left">
    <img src="./icon_4_chrono_2.png" class="top-logo" alt="logo">
    <button id="btnHelp" class="btn-help">Aide</button>
  </div>

  <div class="top-title">
    Pot √† M√®che
  </div>

  <div class="top-right">
    <button id="btnMail" title="Nous contacter / Suggestions">‚úâÔ∏è</button>
    <div>B.Barrois</div>
    <div id="version">version</div>
  </div>
</header>

  <!-- ACTIONS HAUT DE PAGE -->
  <div class="top-actions">
    <button id="btnCapt" class="btn-capt">Capture d‚Äô√©cran</button>

    <div id="dateTime" class="date-time"></div>

    <button id="btnLoc" class="btn-loc">Localisation du nid</button>
  </div>

  <!-- CONTENEUR DES CHRONOS -->
  <main id="chronos">
    <!-- G√©n√©r√© par app.js -->
  </main>

  <!-- SCRIPT PRINCIPAL -->
  <script src="./app.js"></script>

  <!-- AFFICHAGE VERSION -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const v = document.getElementById("version");
      if (v && typeof APP_VERSION !== "undefined") {
        v.textContent = "v. : " + APP_VERSION;
      }
    });
  </script>

  <!-- DATE & HEURE -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const el = document.getElementById("dateTime");
      if (!el) return;

      function updateDateTime() {
        const now = new Date();
        const d = now.toLocaleDateString("fr-FR");
        const t = now.toLocaleTimeString("fr-FR", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit"
        });
        el.textContent = `${d} ${t}`;
      }

      updateDateTime();
      setInterval(updateDateTime, 1000);
    });
  </script>

  <!-- SERVICE WORKER -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./service-worker.js");
    }
  </script>

  <!-- LIB CAPTURE D‚Äô√âCRAN -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- BOUTON CAPTURE -->
  <script>
    document.getElementById("btnCapt").addEventListener("click", async () => {
      const canvas = await html2canvas(document.body, {
        scale: 2,
        useCORS: true
      });

      const blob = await new Promise(resolve =>
        canvas.toBlob(resolve, "image/png")
      );

      const filename =
        "Chrono_Frelon_" +
        new Date().toISOString().replace(/[:.]/g, "-") +
        ".png";

      if (navigator.share) {
        try {
          const file = new File([blob], filename, { type: "image/png" });
          await navigator.share({
            files: [file],
            title: "Chrono Frelon",
            text: "Capture d‚Äô√©cran"
          });
          return;
        } catch (e) {}
      }

      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    });
  </script>

  <!-- BOUTON LOCALISATION -->
  <script>
    document.getElementById("btnLoc").addEventListener("click", () => {
      const observations = [];

      chronos.forEach(c => {
        if (c.lat === "--" || c.lon === "--") return;
        if (c.essais.length === 0) return;

        const total = c.essais.reduce((a, b) => a + b, 0);
        const moyenne = total / c.essais.length;
        const distance = Math.round((moyenne * c.vitesse) / 2);

        observations.push({
          color: c.color,
          lat: parseFloat(c.lat),
          lon: parseFloat(c.lon),
          direction: c.direction,
          distance: distance,
          vitesse: c.vitesse,
          essais: c.essais.length,
          timestamp: new Date().toISOString()
        });
      });

      if (observations.length === 0) {
        alert("Aucune donn√©e exploitable pour la localisation.");
        return;
      }

      localStorage.setItem(
        "chronoObservations",
        JSON.stringify(observations)
      );

      window.location.href = "./map.html";
    });
  </script>
<script>
document.addEventListener("DOMContentLoaded", () => {

  const btn = document.getElementById("btnHelp");
  if (!btn) return;

  btn.addEventListener("click", () => {
    const overlay = document.createElement("div");
    overlay.id = "helpOverlay";

    overlay.innerHTML = `
      <div class="help-box">
        <h2>Aide ‚Äì Application ¬´ Pot √† M√®che ¬ª</h2>

        <h3>1Ô∏è‚É£ Installation de l‚Äôapplication</h3>

        <h4>üì± Android</h4>
        <ol>
          <li>Ouvrez <b>Google Chrome</b></li>
          <li>Allez sur :
            <br><b>https://berny70.github.io/Chrono_Frelon/</b>
          </li>
          <li>Appuyez sur le menu <b>‚ãÆ</b></li>
          <li>S√©lectionnez <b>¬´ Installer l‚Äôapplication ¬ª</b></li>
        </ol>

        <h4>üçé iPhone (iOS)</h4>
        <ol>
          <li>Ouvrez <b>Safari</b></li>
          <li>Allez sur :
            <br><b>https://berny70.github.io/Chrono_Frelon/</b>
          </li>
          <li>Appuyez sur <b>Partager</b> (‚¨ÜÔ∏é)</li>
          <li>Choisissez <b>¬´ Sur l‚Äô√©cran d‚Äôaccueil ¬ª</b></li>
        </ol>

        <hr>

        <h3>2Ô∏è‚É£ Utilisation des chronos</h3>

        <ul>
          <li>Chaque couleur correspond √† une <b>station</b></li>
          <li><b>Position</b> : rel√®ve la localisation</li>
          <li><b>Start / Stop</b> : mesure le temps</li>
          <li><b>Boussole</b> : capture la direction</li>
          <li><b>D√©tail</b> : supprime les valeurs aberrantes</li>
        </ul>

        <p style="margin-top:10px;">
          ‚úîÔ∏è Application gratuite<br>
          ‚úîÔ∏è Sans publicit√© ‚Äì sans compte<br>
          ‚úîÔ∏è Fonctionne hors connexion
        </p>

        <button id="closeHelp">Fermer</button>
      </div>
    `;

    document.body.appendChild(overlay);

    document.getElementById("closeHelp").onclick = () => {
      document.getElementById("helpOverlay")?.remove();
    };
  });

});
</script>

<script>
document.getElementById("btnMail")?.addEventListener("click", () => {
  window.open(
    "https://forms.gle/XXXXXXXXXXXX",
    "_blank"
  );
});
</script>



</body>
</html>
