<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>4 Chronos pour Pot √† M√®che</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#ffffff">

  <!-- Ic√¥ne -->
  <link rel="icon" href="./icon_4_chrono_2.png">

  <!-- Styles -->
  <link rel="stylesheet" href="./style.css">

  <!-- Version -->
  <script src="./version.js"></script>
</head>

<body>

<!-- HEADER -->
<header class="topbar">
  <div class="top-left">
    <img src="./icon_4_chrono_2.png" class="top-logo" alt="logo">
    <button id="btnHelp" class="btn-help">Aide</button>
  </div>

  <div class="top-title">Pot √† M√®che</div>

  <div class="top-right">
    <div class="author">B. Barrois</div>
    <div class="top-right-sub">
      <button id="btnMail" title="Nous contacter / Suggestions">‚úâÔ∏è</button>
      <span id="version">version</span>
    </div>
  </div>
</header>

<!-- ACTIONS -->
<div class="top-actions">
  <button id="btnCapt" class="btn-capt">Capture d‚Äô√©cran</button>
  <div id="dateTime" class="date-time"></div>
  <button id="btnLoc" class="btn-loc">Localisation du nid</button>
</div>

<!-- CHRONOS -->
<main id="chronos"></main>

<!-- SCRIPT PRINCIPAL -->
<script src="./app.js"></script>

<!-- VERSION -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const v = document.getElementById("version");
  if (v && typeof APP_VERSION !== "undefined") {
    v.textContent = "v. : " + APP_VERSION;
  }
});
</script>

<!-- DATE / HEURE -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const el = document.getElementById("dateTime");
  if (!el) return;

  function update() {
    const n = new Date();
    el.textContent =
      n.toLocaleDateString("fr-FR") + " " +
      n.toLocaleTimeString("fr-FR", { hour:"2-digit", minute:"2-digit", second:"2-digit" });
  }
  update();
  setInterval(update, 1000);
});
</script>

<!-- SERVICE WORKER -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js");
}
</script>

<!-- CAPTURE -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
document.getElementById("btnCapt").onclick = async () => {
  const canvas = await html2canvas(document.body, { scale:2, useCORS:true });
  const blob = await new Promise(r => canvas.toBlob(r,"image/png"));
  const name = "Chrono_Frelon_" + new Date().toISOString().replace(/[:.]/g,"-") + ".png";

  if (navigator.share) {
    try {
      await navigator.share({ files:[new File([blob],name)], title:"Chrono Frelon" });
      return;
    } catch(e){}
  }
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
};
</script>

<!-- LOCALISATION DU NID -->
<script>
document.getElementById("btnLoc").onclick = () => {
  const observations = [];

  chronos.forEach(c => {
    if (c.lat === "--" || c.lon === "--") return;
    if (!c.essais.length) return;

    const moy = c.essais.reduce((a,b)=>a+b,0)/c.essais.length;
    const dist = Math.round((moy * c.vitesse) / 2);

    observations.push({
      lat: +c.lat,
      lon: +c.lon,
      direction: c.direction,
      distance: dist
    });
  });

  if (!observations.length) {
    alert("Aucune donn√©e exploitable.");
    return;
  }
  openLocChoice(observations);
};
</script>

<!-- CHOIX LOCAL / PARTAG√â -->
<script>
function openLocChoice(observations) {
  const overlay = document.createElement("div");
  overlay.id = "locChoiceOverlay";
  overlay.innerHTML = `
    <div class="loc-choice-box">
      <h2>Localisation du nid</h2>

      <button id="locLocal">üìç Carte locale</button>

      <button id="locShared">üåê Carte partag√©e</button>

      <p class="link-info">
        <b>https://compteurdevarroas.jodaille.fr/carte_partagee/</b>
      </p>

      <br>
      <button id="locCancel">Annuler</button>
    </div>
  `;
  document.body.appendChild(overlay);

  document.getElementById("locLocal").onclick = () => {
    localStorage.setItem("chronoObservations", JSON.stringify(observations));
    closeLocChoice();
    window.location.href = "./map.html";
  };

  document.getElementById("locShared").onclick = async () => {
    for (const o of observations) {
      await fetch(
        "https://compteurdevarroas.jodaille.fr/carte_partagee/api/add_observation.php",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(o)
        }
      );
    }
    closeLocChoice();
    window.open(
      "https://compteurdevarroas.jodaille.fr/carte_partagee/",
      "_blank"
    );
  };

  document.getElementById("locCancel").onclick = closeLocChoice;
}

function closeLocChoice() {
  document.getElementById("locChoiceOverlay")?.remove();
}
</script>

<!-- CONTACT -->
<script>
document.getElementById("btnMail")?.addEventListener("click", () => {
  window.open("https://forms.gle/e3WaFsaBvvMpk9mx8","_blank");
});
</script>

</body>
</html>
